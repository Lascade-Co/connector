name: App Store Backfill

on:
  workflow_dispatch:
    inputs:
      group:
        description: 'Group to backfill (d1, m4, d2)'
        required: true
        type: choice
        options:
          - d1
          - m4
          - d2
      days:
        description: 'Number of days to backfill'
        required: true
        default: '30'

jobs:
  app-store-backfill:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Setup App Store configuration
        env:
          APP_STORE_CONFIG: ${{ secrets.APP_STORE_CONFIG }}
        run: |
          echo "$APP_STORE_CONFIG" > app_store.json
      
      - name: Setup dlt secrets
        env:
          DLT_SECRETS: ${{ secrets.DLT_SECRETS }}
        run: |
          mkdir -p .dlt
          echo "$DLT_SECRETS" > .dlt/secrets.toml
      
      - name: Run App Store Backfill
        env:
          APPSTORE_BACKFILL_DAYS: ${{ github.event.inputs.days }}
          PIPELINE_NAME_SUFFIX: _backfill
        run: |
          python main.py app_store ${{ github.event.inputs.group }}
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: app-store-backfill-logs-${{ github.event.inputs.group }}
          path: |
            *.log
            .dlt/*.log
